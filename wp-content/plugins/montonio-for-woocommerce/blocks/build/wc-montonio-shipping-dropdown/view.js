(()=>{"use strict";const e=window.React,o=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"montonio-for-woocommerce/wc-montonio-shipping-dropdown","version":"0.1.0","title":"Montonio Shipping Pickup Point Dropdown Block","category":"woocommerce","description":"Adds a Montonio Shipping Pickup Point Dropdown to the checkout page.","supports":{"html":false,"align":false,"multiple":false,"reusable":false},"parent":["woocommerce/checkout-shipping-methods-block"],"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}}},"textdomain":"montonio-for-woocommerce","editorScript":"file:./index.js","viewScript":"file:./view.js"}'),t=window.wp.element,n=window.wp.i18n,i=window.wc.blocksCheckout,a=window.wp.data,c=window.lodash,{getSetting:s}=wc.wcSettings,r=s("wc-montonio-shipping-dropdown_data",{}),p={metadata:o,component:({checkoutExtensionData:o})=>{const[i,s]=(0,t.useState)(""),[p,l]=(0,t.useState)([]),[d,u]=(0,t.useState)(!1),[m,w]=(0,t.useState)(!1),[h,g]=(0,t.useState)(!1),{setExtensionData:k}=o,f=(0,t.useRef)(null),b=(0,t.useRef)(null),S="montonio-pickup-point",{setValidationErrors:E,clearValidationError:v}=(0,a.useDispatch)("wc/store/validation"),C=(0,a.useSelect)((e=>e("wc/store/validation").getValidationError(S))),{selectedShippingRate:y,shippingAddress:_,isCustomerDataUpdating:D}=(0,a.useSelect)((e=>{const o=e("wc/store/cart"),t=o.getCartData();return{selectedShippingRate:t.shippingRates?.[0]?.shipping_rates?.find((e=>e.selected))?.rate_id||null,shippingAddress:t.shippingAddress||{},isCustomerDataUpdating:o.isCustomerDataUpdating()}})),M=(0,t.useCallback)((0,c.debounce)(((e,o,t)=>{k(e,o,t)}),1e3),[k]),j=(0,t.useCallback)((e=>{const o=e.target.value;s(o),M("montonio-for-woocommerce","selected_pickup_point",o),g(!0)}),[M]),A=(0,t.useCallback)((async(e,o)=>{f.current&&f.current.abort();const t=new AbortController;f.current=t,u(!0);try{const n=await fetch(`${r.getShippingMethodItemsUrl}?shipping_method=${e}&country=${o}`,{headers:{"Content-Type":"application/json","X-WP-Nonce":r.nonce},signal:t.signal});if(!n.ok)throw new Error("Network response was not ok");return await n.json()}catch(e){return"AbortError"===e.name?console.log("Fetch aborted"):console.error("Error fetching pickup points:",e),{}}finally{u(!1),f.current=null}}),[]),N=(0,t.useCallback)((e=>Object.entries(e).map((([e,o])=>({label:e,options:o.map((o=>({value:o.id,label:`${o.name}${"yes"===r.includeAddress&&o.address?.trim()?` - ${o.address}, ${e}`:""}`})))})))),[]),$=(0,t.useCallback)((0,c.debounce)((async(e,o,t)=>{const n=await A(o,t),i=N(n);l(i),s(""),g(!1),u(!1)}),400),[A,N,j]),P=(0,t.useCallback)(((e,o)=>{const[t]=(e||":").split(":"),n=t.startsWith("montonio_")&&(t.endsWith("parcel_machines")||t.endsWith("post_offices"));w(n),n?(u(!0),$(e,t,o)):(l([]),s(""))}),[$]);(0,t.useEffect)((()=>{(y!==b.current||D)&&(P(y,_.country),b.current=y)}),[D,y,_.country,P]);const R=(0,t.useCallback)((()=>{if(!m)return;const e=document.getElementById("montonio-shipping-pickup-point-dropdown");e&&("undefined"!=typeof Montonio&&Montonio.Checkout&&Montonio.Checkout.ShippingDropdown?(window.montonioShippingDropdown&&window.montonioShippingDropdown.destroy(),window.montonioShippingDropdown=new Montonio.Checkout.ShippingDropdown({shippingMethod:y,accessKey:r.accessKey,targetId:"montonio-shipping-pickup-point-dropdown",shouldInjectCSS:!0,onLoaded:function(){const o=e.value;o&&j({target:{value:o}})}}),window.montonioShippingDropdown.init()):console.warn("Montonio SDK not available"))}),[m,y,j]);(0,t.useEffect)((()=>{p.length>0&&m&&requestAnimationFrame((()=>{R()}))}),[p,m,R]),(0,t.useEffect)((()=>{m&&""===i?E({[S]:{message:(0,n.__)("Please select a pickup point","montonio-for-woocommerce"),hidden:!h}}):C&&v(S)}),[m,i,E,v,S,h,C]);const x=(0,t.useCallback)((o=>[(0,e.createElement)("option",{key:"default",value:""},(0,n.__)("Select a pickup point","montonio-for-woocommerce")),...o.map(((o,t)=>(0,e.createElement)("optgroup",{key:t,label:o.label},o.options.map((o=>(0,e.createElement)("option",{key:o.value,value:o.value},o.label))))))]),[]);return(0,e.createElement)("div",{id:"montonio-shipping-pickup-point-dropdown-wrapper"},m&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("h2",{className:"wc-block-components-title wc-block-components-checkout-step__title"},(0,n.__)("Pickup point","montonio-for-woocommerce")),d?(0,e.createElement)("p",null,(0,n.__)("Loading pickup points...","montonio-for-woocommerce")):(0,e.createElement)("div",{className:!1===C?.hidden?"has-error":""},(0,e.createElement)("input",{type:"text",className:"montonio-pickup-point-id",name:"montonio-pickup-point-id",value:i}),(0,e.createElement)("select",{id:"montonio-shipping-pickup-point-dropdown",onChange:j,value:i,className:!1===C?.hidden?"has-error":""},x(p)),!1===C?.hidden&&(0,e.createElement)("div",{className:"wc-block-components-validation-error"},(0,e.createElement)("p",null,C.message)))))}};(0,i.registerCheckoutBlock)(p)})();