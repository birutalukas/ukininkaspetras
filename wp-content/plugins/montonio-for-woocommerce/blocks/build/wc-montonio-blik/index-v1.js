(()=>{"use strict";const e=window.React,t=window.wp.element,n=window.wp.data,o=window.wp.i18n,{registerPaymentMethod:i}=wc.wcBlocksRegistry,{getSetting:a}=wc.wcSettings,{decodeEntities:r}=wp.htmlEntities,{applyFilters:c,addFilter:l}=wp.hooks,s=a("wc_montonio_blik_data",{}),m=c("wc_montonio_blik_block_title",r(s.title||(0,o.__)("BLIK","montonio-for-woocommerce")),s);l("wc_montonio_blik_block_description","montonio-for-woocommerce",((e,t)=>("yes"===t.sandboxMode&&(e="<strong>"+(0,o.__)("TEST MODE ENABLED!","montonio-for-woocommerce")+"</strong><br>"+(0,o.__)("When test mode is enabled, payment providers do not process payments.","montonio-for-woocommerce")+"<br>"+e),e)));const d=c("wc_montonio_blik_block_description",r(s.description),s),u=n=>(0,e.createElement)(t.RawHTML,null,n),w=({setIsFormCompleted:i,setEmbeddedPayment:a})=>{const[r,c]=(0,t.useState)(!1),[l,m]=(0,t.useState)(!1),[d,u]=(0,t.useState)(null),w=(0,n.useSelect)((e=>{const t=e("wc/store/cart").getCustomerData();return t.billingAddress.country||t.shippingAddress.country})),p=(0,t.useCallback)((async()=>{if(c(!0),u(null),window.blikIntentData)return await y(),m(!0),void c(!1);const e=new FormData;e.append("action","get_payment_intent"),e.append("method","blik"),e.append("sandbox_mode",s.sandboxMode),e.append("nonce",s.nonce);try{const t=await fetch(woocommerce_params.ajax_url,{method:"POST",credentials:"same-origin",body:e}),n=await t.json();if(!n.success)throw new Error(n.data||"Failed to initialize payment");window.blikIntentData=n.data,await y(),m(!0)}catch(e){console.error("Error initializing payment:",e),u(e.message||"Failed to initialize payment")}finally{c(!1)}}),[]),y=async()=>{try{if("undefined"==typeof Montonio||void 0===Montonio.Checkout)throw new Error("Montonio SDK is not loaded");const e=await Montonio.Checkout.EmbeddedPayments.initializePayment({stripePublicKey:window.blikIntentData.stripePublicKey,stripeClientSecret:window.blikIntentData.stripeClientSecret,paymentIntentUuid:window.blikIntentData.uuid,locale:s.locale||"en",country:w||"EE",targetId:"montonio-blik-form"});e.on("change",(e=>{i(e.isCompleted)})),a(e)}catch(e){console.error("Error in initializePayment:",e)}};return(0,t.useEffect)((()=>{l||p()}),[l,p]),(0,e.createElement)("div",{id:"montonio-blik-form-wrapper",className:r?"loading":"",style:r?{opacity:.6}:{}},r&&(0,e.createElement)("div",{className:"montonio-loader"},(0,o.__)("Loading...","montonio-for-woocommerce")),d&&(0,e.createElement)("div",{className:"montonio-error"},d),(0,e.createElement)("div",{id:"montonio-blik-form"}))},p=({eventRegistration:i})=>{if("yes"!==s.inlineCheckout)return d?(0,e.createElement)("p",{className:"montonio-payment-block-description"},u(d)):null;const{onPaymentSetup:a,onCheckoutSuccess:r}=i,[c,l]=(0,t.useState)(!1),[m,p]=(0,t.useState)(null),{createErrorNotice:y,removeNotice:b}=(0,n.useDispatch)("core/notices"),_=document.getElementById("montonio-blik-form"),[k,E]=(0,t.useState)(!1);return(0,t.useEffect)((()=>{const e=a((()=>(b("wc-montonio-blik-error","wc/checkout"),!_||""===_.innerHTML.trim()||c?{type:"success",meta:{paymentMethodData:{montonio_blik_payment_intent_uuid:window.blikIntentData?.uuid||""}}}:{type:"error",message:(0,o.__)("Please fill in the required fields for the payment method.","montonio-for-woocommerce")}))),t=r((async e=>{if(_&&""!==_.innerHTML.trim())try{return{type:"success",redirectUrl:(await m.confirmPayment("yes"===s.sandboxMode)).returnUrl}}catch(e){const t=e.message||(0,o.__)("An error occurred during payment processing. Please try again.","montonio-for-woocommerce");return y(t,{context:"wc/checkout"}),window.blikIntentData=null,E((e=>!e)),{type:"error",message:t,retry:!0}}}));return()=>{e(),t()}}),[a,r,c,m,y,b]),(0,e.createElement)(e.Fragment,null,d&&(0,e.createElement)("p",{className:"montonio-payment-block-description"},u(d)),(0,e.createElement)(w,{setIsFormCompleted:l,setEmbeddedPayment:p,key:k}))},y=()=>(0,e.createElement)("span",null,(0,e.createElement)("img",{src:s.iconurl,alt:"Montonio BLIK"}));i({name:"wc_montonio_blik",label:(0,e.createElement)((()=>(0,e.createElement)("span",null,m,(0,e.createElement)(y,null))),null),content:(0,e.createElement)(p,null),edit:(0,e.createElement)(p,null),canMakePayment:()=>c("wc_montonio_blik_block_enabled",!0,s),ariaLabel:m})})();