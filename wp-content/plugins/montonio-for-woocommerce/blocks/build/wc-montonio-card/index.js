(()=>{"use strict";const e=window.React,t=window.wp.element,n=window.wp.data,o=window.wp.i18n,{registerPaymentMethod:a}=wc.wcBlocksRegistry,{getSetting:r}=wc.wcSettings,{decodeEntities:c}=wp.htmlEntities,{applyFilters:i,addFilter:s}=wp.hooks,m=r("wc_montonio_card_data",{}),d=i("wc_montonio_card_block_title",c(m.title||(0,o.__)("Card Payment","montonio-for-woocommerce")),m);s("wc_montonio_card_block_description","montonio-for-woocommerce",((e,t)=>("yes"===t.sandboxMode&&(e="<strong>"+(0,o.__)("TEST MODE ENABLED!","montonio-for-woocommerce")+"</strong><br>"+(0,o.__)("When test mode is enabled, payment providers do not process payments.","montonio-for-woocommerce")+"<br>"+e),e)));const l=i("wc_montonio_card_block_description",c(m.description),m),u=n=>(0,e.createElement)(t.RawHTML,null,n),w=({setIsFormCompleted:a,setEmbeddedPayment:r})=>{const[c,i]=(0,t.useState)(!1),[s,d]=(0,t.useState)(!1),[l,u]=(0,t.useState)(null),w=(0,n.useSelect)((e=>{const t=e("wc/store/cart").getCustomerData();return t.billingAddress.country||t.shippingAddress.country})),p=(0,t.useCallback)((async()=>{if(i(!0),u(null),window.cardPaymentsIntentData)return await y(),d(!0),void i(!1);const e=new FormData;e.append("action","get_payment_intent"),e.append("method","cardPayments"),e.append("sandbox_mode",m.sandboxMode),e.append("nonce",m.nonce);try{const t=await fetch(woocommerce_params.ajax_url,{method:"POST",credentials:"same-origin",body:e}),n=await t.json();if(!n.success)throw new Error(n.data||"Failed to initialize payment");window.cardPaymentsIntentData=n.data,await y(),d(!0)}catch(e){console.error("Error initializing payment:",e),u(e.message||"Failed to initialize payment")}finally{i(!1)}}),[]),y=async()=>{try{if("undefined"==typeof Montonio||void 0===Montonio.Checkout)throw new Error("Montonio SDK is not loaded");const e=await Montonio.Checkout.EmbeddedPayments.initializePayment({stripePublicKey:window.cardPaymentsIntentData.stripePublicKey,stripeClientSecret:window.cardPaymentsIntentData.stripeClientSecret,paymentIntentUuid:window.cardPaymentsIntentData.uuid,locale:m.locale||"en",country:w||"EE",targetId:"montonio-card-form"});e.on("change",(e=>{a(e.isCompleted)})),r(e)}catch(e){console.error("Error in initializePayment:",e)}};return(0,t.useEffect)((()=>{s||p()}),[s,p]),(0,e.createElement)("div",{id:"montonio-card-form-wrapper",className:c?"loading":"",style:c?{opacity:.6}:{}},c&&(0,e.createElement)("div",{className:"montonio-loader"},(0,o.__)("Loading...","montonio-for-woocommerce")),l&&(0,e.createElement)("div",{className:"montonio-error"},l),(0,e.createElement)("div",{id:"montonio-card-form"}))},p=({eventRegistration:a})=>{if("yes"!==m.inlineCheckout)return l?(0,e.createElement)("p",{className:"montonio-payment-block-description"},u(l)):null;const{onPaymentSetup:r,onCheckoutSuccess:c}=a,[i,s]=(0,t.useState)(!1),[d,p]=(0,t.useState)(null),{createErrorNotice:y,removeNotice:_}=(0,n.useDispatch)("core/notices"),E=document.getElementById("montonio-card-form"),[g,f]=(0,t.useState)(!1);return(0,t.useEffect)((()=>{const e=r((()=>(_("wc-montonio-card-error","wc/checkout"),!E||""===E.innerHTML.trim()||i?{type:"success",meta:{paymentMethodData:{montonio_card_payment_intent_uuid:window.cardPaymentsIntentData?.uuid||""}}}:{type:"error",message:(0,o.__)("Please fill in the required fields for the payment method.","montonio-for-woocommerce")}))),t=c((async e=>{if(E&&""!==E.innerHTML.trim())try{return{type:"success",redirectUrl:(await d.confirmPayment("yes"===m.sandboxMode)).returnUrl}}catch(e){console.log(e.message);const t=e.message||(0,o.__)("An error occurred during payment processing. Please try again.","montonio-for-woocommerce");return y(t,{context:"wc/checkout"}),window.cardPaymentsIntentData=null,f((e=>!e)),{type:"error",message:t,retry:!0}}}));return()=>{e(),t()}}),[r,c,i,d,y,_]),(0,e.createElement)(e.Fragment,null,l&&(0,e.createElement)("p",{className:"montonio-payment-block-description"},u(l)),(0,e.createElement)(w,{setIsFormCompleted:s,setEmbeddedPayment:p,key:g}))},y=()=>(0,e.createElement)("span",null,(0,e.createElement)("img",{src:m.iconurl,alt:"Montonio Card"}));a({name:"wc_montonio_card",label:(0,e.createElement)((()=>(0,e.createElement)("span",null,d,(0,e.createElement)(y,null))),null),content:(0,e.createElement)(p,null),edit:(0,e.createElement)(p,null),canMakePayment:()=>i("wc_montonio_card_block_enabled",!0,m),ariaLabel:d})})();